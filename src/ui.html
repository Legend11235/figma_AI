<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta
    http-equiv="Content-Security-Policy"
    content="default-src 'none'; img-src data: blob:; style-src 'unsafe-inline'; script-src 'self' 'unsafe-inline'; connect-src https://api.gumloop.com http://localhost:8000;"
  />
  <title>Figma Cursor</title>
  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 16px;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      font-size: 12px;
      color: #f0f0f0;
      background-color: #2a2a2a;
    }
    #root {
      width: 100%;
    }
    button {
      padding: 10px 16px;
      background-color: #18a0fb;
      color: white;
      border: none;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      width: 100%;
    }
    button:hover { background-color: #0d66d0; }
  </style>
</head>
<body>
  <div id="root">
    <h2>AI Design Predictor</h2>
    <button id="predict-btn">Predict Next Element</button>
    <p id="status" style="margin-top: 12px; font-size: 11px; color: #999;"></p>
  </div>

  <script>
    console.log('UI Script loaded');
    
    const btn = document.getElementById('predict-btn');
    const status = document.getElementById('status');
    
    if (btn) {
      console.log('Button found');
      btn.addEventListener('click', function() {
        console.log('Button clicked');
        status.textContent = 'Fetching layers...';
        btn.disabled = true;
        parent.postMessage({ pluginMessage: { type: 'fetch-layers' } }, '*');
      });
    } else {
      console.error('Button not found');
    }

    window.onmessage = async function(event) {
      console.log('Message received:', event.data);
      const msg = event.data.pluginMessage;
      if (msg.type === 'layers-data') {
        status.textContent = 'Calling Gumloop...';
        console.log('Selection:', msg.selection);
        
        // Send selection to main thread to start pipeline
        console.log('Sending selection to main thread for Gumloop call');
        parent.postMessage({ pluginMessage: { type: 'start-gumloop', selection: msg.selection } }, '*');
      }
      
      if (msg.type === 'prediction-ready') {
        console.log('Received prediction results:', msg.actions);
        if (Array.isArray(msg.actions) && msg.actions.length > 0) {
          status.textContent = 'Rendering ' + msg.actions.length + ' predictions...';
        } else {
          status.textContent = 'No actions returned from AI';
        }
        btn.disabled = false;
      }
      
      if (msg.type === 'prediction-error') {
        console.error('Prediction error:', msg.error);
        status.textContent = 'Error: ' + msg.error;
        btn.disabled = false;
      }
    };
  </script>
</body>
</html>
