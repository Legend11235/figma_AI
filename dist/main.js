(()=>{"use strict";({927(){var e=this&&this.__awaiter||function(e,t,o,r){return new(o||(o=Promise))(function(n,i){function s(e){try{c(r.next(e))}catch(e){i(e)}}function a(e){try{c(r.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(s,a)}c((r=r.apply(e,t||[])).next())})};figma.showUI(__html__,{width:320,height:240,themeColors:!0});const t={family:"Inter",style:"Regular"},o=(e,t=0)=>{const o="number"==typeof e?e:Number(e);return Number.isFinite(o)?o:t},r=(e,t)=>{e.x=o(t.x,e.x),e.y=o(t.y,e.y)},n=(e,t)=>{if(!("resize"in e))return;const r=void 0!==t.w,n=void 0!==t.h;if(!r&&!n)return;const i=r?o(t.w,e.width):e.width,s=n?o(t.h,e.height):e.height;e.resize(i,s)},i=o=>e(void 0,void 0,void 0,function*(){if(!o||"object"!=typeof o)return null;if("CREATE"!==("string"==typeof o.action?o.action.toUpperCase():"CREATE"))return null;const e="string"==typeof o.type?o.type.toUpperCase():"",i="string"==typeof o.name?o.name:"";switch(e){case"TEXT":{const e=figma.createText();try{yield figma.loadFontAsync(t),e.fontName=t;const r=o.text||o.content||o.name||"Text";e.characters=String(r)}catch(e){return console.error("Failed to load font for text:",e),null}return i&&(e.name=i),void 0===o.w&&void 0===o.h||(e.textAutoResize="NONE",n(e,o)),r(e,o),e}case"RECTANGLE":{const e=figma.createRectangle();return i&&(e.name=i),n(e,o),r(e,o),e}case"ELLIPSE":{const e=figma.createEllipse();return i&&(e.name=i),n(e,o),r(e,o),e}case"FRAME":{const e=figma.createFrame();return i&&(e.name=i),n(e,o),r(e,o),e}case"LINE":{const e=figma.createLine();return i&&(e.name=i),n(e,o),r(e,o),e}case"COMPONENT":{const e=figma.createComponent();return i&&(e.name=i),n(e,o),r(e,o),e}default:return console.warn("Unknown action type:",o.type),null}});figma.ui.onmessage=t=>e(void 0,void 0,void 0,function*(){var e,o,r,n,s,a,c;if(console.log("Main thread received message:",t),"fetch-layers"===t.type){console.log("Fetching layers from selection");const e=figma.currentPage.selection.map(e=>({name:e.name,type:e.type,x:e.x,y:e.y,w:e.width,h:e.height}));console.log("Sending selection to UI:",e),figma.ui.postMessage({type:"layers-data",selection:e})}if("start-gumloop"===t.type){console.log("Starting Gumloop via proxy with selection:",t.selection);try{const l=yield fetch("http://localhost:8000/run-flow?saved_item_id=sbTctfNvijqsLZMHmXXqpi",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({figma_json:JSON.stringify(t.selection)})});console.log("Proxy response status:",l.status);const u=yield l.text();if(!u)return void figma.ui.postMessage({type:"prediction-error",error:`Empty proxy response (status ${l.status})`});let p;try{p=JSON.parse(u)}catch(e){return console.error("Failed to parse proxy response as JSON:",e),void figma.ui.postMessage({type:"prediction-error",error:"Proxy returned non-JSON response"})}if(console.log("Proxy response:",p),!p.success)return void figma.ui.postMessage({type:"prediction-error",error:p.error||"Unknown error"});const d=e=>{if(!e)return"";if("string"==typeof e)return e;if(Array.isArray(e))return e.find(e=>"string"==typeof e&&e.trim())||"";if("object"==typeof e){const t=["output","Response","response","text"];for(const o of t)if("string"==typeof e[o]&&e[o].trim())return e[o];for(const t of Object.values(e))if("string"==typeof t&&t.trim())return t}return""};let f="";const g=[null===(e=null==p?void 0:p.data)||void 0===e?void 0:e.output,null===(o=null==p?void 0:p.data)||void 0===o?void 0:o.outputs,null===(n=null===(r=null==p?void 0:p.data)||void 0===r?void 0:r.result)||void 0===n?void 0:n.output,null===(a=null===(s=null==p?void 0:p.data)||void 0===s?void 0:s.result)||void 0===a?void 0:a.outputs,null===(c=null==p?void 0:p.data)||void 0===c?void 0:c.result];for(const e of g)if(f=d(e),f)break;console.log("Extracted output:",f);let y=[];try{let e=f;if("string"==typeof f){if(e=f.replace(/```json\n?|\n?```/g,"").trim(),!e)return void figma.ui.postMessage({type:"prediction-error",error:"AI response was empty"});y=JSON.parse(e)}else y=f;console.log("Parsed actions:",y)}catch(e){return console.error("Failed to parse output as JSON:",e),void figma.ui.postMessage({type:"prediction-error",error:"Failed to parse AI response"})}if(Array.isArray(y)&&y.length>0){console.log("Rendering "+y.length+" predictions"),figma.ui.postMessage({type:"prediction-ready",actions:y});const e=[];for(const t of y){const o=yield i(t);o&&e.push(o)}e.length>0?(figma.currentPage.selection=e,figma.viewport.scrollAndZoomIntoView(e)):figma.ui.postMessage({type:"prediction-error",error:"No supported actions returned from AI"})}else figma.ui.postMessage({type:"prediction-error",error:"No actions returned from AI"})}catch(e){console.error("Proxy error:",e),figma.ui.postMessage({type:"prediction-error",error:String(e)})}}if("render-prediction"===t.type){console.log("Rendering prediction:",t.actions);const e=[];for(const o of t.actions){const t=yield i(o);t&&e.push(t)}e.length>0?(figma.currentPage.selection=e,figma.viewport.scrollAndZoomIntoView(e)):figma.ui.postMessage({type:"prediction-error",error:"No supported actions returned from AI"})}})}})[927].call({})})();