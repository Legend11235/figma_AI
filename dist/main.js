(()=>{"use strict";({927(){var e=this&&this.__awaiter||function(e,t,o,i){return new(o||(o=Promise))(function(n,r){function s(e){try{c(i.next(e))}catch(e){r(e)}}function a(e){try{c(i.throw(e))}catch(e){r(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof o?t:new o(function(e){e(t)})).then(s,a)}c((i=i.apply(e,t||[])).next())})};figma.showUI(__html__,{width:320,height:240,themeColors:!0});const t={family:"Inter",style:"Regular"},o={r:0,g:0,b:0},i=(e,t=0)=>{const o="number"==typeof e?e:Number(e);return Number.isFinite(o)?o:t},n=e=>{const t=e.replace("#","").trim();return 3===t.length?{r:parseInt(t[0]+t[0],16)/255,g:parseInt(t[1]+t[1],16)/255,b:parseInt(t[2]+t[2],16)/255}:6===t.length||8===t.length?{r:parseInt(t.slice(0,2),16)/255,g:parseInt(t.slice(2,4),16)/255,b:parseInt(t.slice(4,6),16)/255}:o},r=(e,t)=>{e.x=i(t.x,e.x),e.y=i(t.y,e.y)},s=(e,t)=>{if(!("resize"in e))return;const o=void 0!==t.w?t.w:t.width,n=void 0!==t.h?t.h:t.height,r=void 0!==o,s=void 0!==n;if(!r&&!s)return;const a=r?i(o,e.width):e.width,c=s?i(n,e.height):e.height;e.resize(a,c)},a=(e,t)=>{"layoutMode"in e&&(void 0!==t.layoutMode&&(e.layoutMode=t.layoutMode),void 0!==t.primaryAxisSizingMode&&(e.primaryAxisSizingMode=t.primaryAxisSizingMode),void 0!==t.counterAxisSizingMode&&(e.counterAxisSizingMode=t.counterAxisSizingMode),void 0!==t.primaryAxisAlignItems&&(e.primaryAxisAlignItems=t.primaryAxisAlignItems),void 0!==t.counterAxisAlignItems&&(e.counterAxisAlignItems=t.counterAxisAlignItems),void 0!==t.paddingTop&&(e.paddingTop=i(t.paddingTop,0)),void 0!==t.paddingBottom&&(e.paddingBottom=i(t.paddingBottom,0)),void 0!==t.paddingLeft&&(e.paddingLeft=i(t.paddingLeft,0)),void 0!==t.paddingRight&&(e.paddingRight=i(t.paddingRight,0)),void 0!==t.itemSpacing&&(e.itemSpacing=i(t.itemSpacing,0)))},c=(e,t)=>{"layoutAlign"in e&&void 0!==t.layoutAlign&&(e.layoutAlign=t.layoutAlign),"layoutGrow"in e&&void 0!==t.layoutGrow&&(e.layoutGrow=i(t.layoutGrow,0))},l=(d,p)=>e(void 0,void 0,void 0,function*(){const u=(e=>{if(!e)return null;if("string"==typeof e){const t=e.trim();if(t.startsWith("{")&&t.endsWith("}"))try{return JSON.parse(t)}catch(e){console.warn("Failed to parse action string as JSON:",e)}return null}return"object"!=typeof e?null:e.create&&"object"==typeof e.create?e.create:e.payload&&"object"==typeof e.payload?e.payload:e.node&&"object"==typeof e.node?e.node:e.element&&"object"==typeof e.element?e.element:e.action&&"object"==typeof e.action?e.action:e})(d);if(!u||"object"!=typeof u)return null;const f=(e=>{if("string"!=typeof e)return"CREATE";const t=e.toUpperCase();return t.includes("CREATE")||t.includes("ADD")?"CREATE":t})(u.action||u.operation||u.op||u.actionType);if("CREATE"!==f)return null;const g=((e,t)=>{const o=("string"==typeof e?e:"string"==typeof t?t:"").toUpperCase();return o.includes("TEXT")?"TEXT":o.includes("RECT")?"RECTANGLE":o.includes("ELLIPSE")||o.includes("OVAL")?"ELLIPSE":o.includes("FRAME")?"FRAME":o.includes("LINE")?"LINE":o.includes("COMPONENT")?"COMPONENT":o})(u.type||u.nodeType||u.kind,u.action),y="string"==typeof u.name?u.name:"";let m=null;switch(g){case"TEXT":{const e=figma.createText();try{const o=(v=u.fontName)&&"object"==typeof v&&v.family&&v.style?{family:String(v.family),style:String(v.style)}:t;yield figma.loadFontAsync(o),e.fontName=o;const n=u.text||u.content||u.name||"Text";e.characters=String(n),((e,t)=>{"string"==typeof t.characters&&(e.characters=t.characters),void 0!==t.fontSize&&(e.fontSize=i(t.fontSize,Number(e.fontSize))),t.lineHeight&&"object"==typeof t.lineHeight&&(e.lineHeight={unit:t.lineHeight.unit,value:i(t.lineHeight.value,0)})})(e,u)}catch(e){return console.error("Failed to load font for text:",e),null}y&&(e.name=y),void 0===u.w&&void 0===u.h||(e.textAutoResize="NONE",s(e,u)),r(e,u),m=e;break}case"RECTANGLE":{const e=figma.createRectangle();y&&(e.name=y),s(e,u),r(e,u),m=e;break}case"ELLIPSE":{const e=figma.createEllipse();y&&(e.name=y),s(e,u),r(e,u),m=e;break}case"FRAME":{const e=figma.createFrame();y&&(e.name=y),a(e,u),s(e,u),r(e,u),m=e;break}case"LINE":{const e=figma.createLine();y&&(e.name=y),s(e,u),r(e,u),m=e;break}case"COMPONENT":{const e=figma.createComponent();y&&(e.name=y),a(e,u),s(e,u),r(e,u),m=e;break}case"INSTANCE":{const t=yield(t=>e(void 0,void 0,void 0,function*(){if(t.componentKey)try{return(yield figma.importComponentByKeyAsync(String(t.componentKey))).createInstance()}catch(e){console.warn("Failed to import component by key:",e)}if(t.componentId){const e=figma.getNodeById(String(t.componentId));if(e&&"COMPONENT"===e.type)return e.createInstance()}return null}))(u);if(t)y&&(t.name=y),a(t,u),s(t,u),r(t,u),m=t;else{console.warn("No component reference for instance; creating frame instead.");const e=figma.createFrame();y&&(e.name=y),a(e,u),s(e,u),r(e,u),m=e}break}default:return console.warn("Unsupported action type:",{action:f,type:g,item:u}),null}var v;if(!m)return null;if(((e,t)=>{"cornerRadius"in e&&void 0!==t.cornerRadius&&(e.cornerRadius=i(t.cornerRadius,0))})(m,u),((e,t)=>{if(!("fills"in e))return;if(!Array.isArray(t.fills))return;const o=t.fills.map(e=>"string"==typeof e?{type:"SOLID",color:n(e)}:e&&"object"==typeof e&&"SOLID"===e.type&&e.color?e:null).filter(Boolean);o.length>0&&(e.fills=o)})(m,u),((e,t)=>{if(!("effects"in e))return;if(!Array.isArray(t.effects))return;const r=t.effects.map(e=>{var t,r;if(!e||"object"!=typeof e)return null;if("DROP_SHADOW"===e.type){const s="string"==typeof e.color?n(e.color):o,a=i(e.opacity,1);return{type:"DROP_SHADOW",color:Object.assign(Object.assign({},s),{a}),offset:{x:i(null===(t=e.offset)||void 0===t?void 0:t.x,0),y:i(null===(r=e.offset)||void 0===r?void 0:r.y,0)},radius:i(e.radius,0),spread:i(e.spread,0),visible:!1!==e.visible,blendMode:"NORMAL"}}return null}).filter(Boolean);r.length>0&&(e.effects=r)})(m,u),c(m,u),p&&"appendChild"in p&&p.appendChild(m),Array.isArray(u.children)&&"appendChild"in m)for(const e of u.children){const t=yield l(e,m);t&&c(t,e)}return m});figma.ui.onmessage=t=>e(void 0,void 0,void 0,function*(){var e,o,i,n,r,s,a;if(console.log("Main thread received message:",t),"fetch-layers"===t.type){console.log("Fetching layers from selection");const e=figma.currentPage.selection.map(e=>({name:e.name,type:e.type,x:e.x,y:e.y,w:e.width,h:e.height}));console.log("Sending selection to UI:",e),figma.ui.postMessage({type:"layers-data",selection:e})}if("start-gumloop"===t.type){console.log("Starting Gumloop via proxy with selection:",t.selection);try{const c=yield fetch("http://localhost:8000/run-flow?saved_item_id=sbTctfNvijqsLZMHmXXqpi",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({figma_json:JSON.stringify(t.selection)})});console.log("Proxy response status:",c.status);const d=yield c.text();if(!d)return void figma.ui.postMessage({type:"prediction-error",error:`Empty proxy response (status ${c.status})`});let p;try{p=JSON.parse(d)}catch(e){return console.error("Failed to parse proxy response as JSON:",e),void figma.ui.postMessage({type:"prediction-error",error:"Proxy returned non-JSON response"})}if(console.log("Proxy response:",p),!p.success)return void figma.ui.postMessage({type:"prediction-error",error:p.error||"Unknown error"});const u=e=>{if(!e)return"";if("string"==typeof e)return e;if(Array.isArray(e))return e.find(e=>"string"==typeof e&&e.trim())||"";if("object"==typeof e){const t=["output","Response","response","text"];for(const o of t)if("string"==typeof e[o]&&e[o].trim())return e[o];for(const t of Object.values(e))if("string"==typeof t&&t.trim())return t}return""};let f="";const g=[null===(e=null==p?void 0:p.data)||void 0===e?void 0:e.output,null===(o=null==p?void 0:p.data)||void 0===o?void 0:o.outputs,null===(n=null===(i=null==p?void 0:p.data)||void 0===i?void 0:i.result)||void 0===n?void 0:n.output,null===(s=null===(r=null==p?void 0:p.data)||void 0===r?void 0:r.result)||void 0===s?void 0:s.outputs,null===(a=null==p?void 0:p.data)||void 0===a?void 0:a.result];for(const e of g)if(f=u(e),f)break;console.log("Extracted output:",f);let y=[];try{let e=f;if("string"==typeof f){if(e=f.replace(/```json\n?|\n?```/g,"").trim(),!e)return void figma.ui.postMessage({type:"prediction-error",error:"AI response was empty"});y=JSON.parse(e)}else y=f;console.log("Parsed actions:",y)}catch(e){return console.error("Failed to parse output as JSON:",e),void figma.ui.postMessage({type:"prediction-error",error:"Failed to parse AI response"})}if(!Array.isArray(y)&&y&&"object"==typeof y&&(y=[y]),Array.isArray(y)&&y.length>0){console.log("Rendering "+y.length+" predictions"),figma.ui.postMessage({type:"prediction-ready",actions:y});const e=[];for(const t of y){const o=yield l(t);o&&e.push(o)}e.length>0?(figma.currentPage.selection=e,figma.viewport.scrollAndZoomIntoView(e)):figma.ui.postMessage({type:"prediction-error",error:"No supported actions returned from AI"})}else figma.ui.postMessage({type:"prediction-error",error:"No actions returned from AI"})}catch(e){console.error("Proxy error:",e),figma.ui.postMessage({type:"prediction-error",error:String(e)})}}if("render-prediction"===t.type){console.log("Rendering prediction:",t.actions);const e=[];for(const o of t.actions){const t=yield l(o);t&&e.push(t)}e.length>0?(figma.currentPage.selection=e,figma.viewport.scrollAndZoomIntoView(e)):figma.ui.postMessage({type:"prediction-error",error:"No supported actions returned from AI"})}})}})[927].call({})})();